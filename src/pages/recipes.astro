---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { bakeryAPI } from '../lib/supabase';

// Fetch recipes from Supabase
const recipes = await bakeryAPI.getRecipes();
---

<Layout title="Favorite Recipes - Whisked Away Bakery">
  <Navigation />
  
  <main class="pt-20 pb-16">
    <section class="py-20 bg-gradient-to-br from-purple-50 to-gold-50">
      <div class="max-w-6xl mx-auto px-4">
        <div class="text-center mb-16">
          <h1 class="font-script text-5xl md:text-6xl font-bold text-purple-800 mb-6">
            Favorite Recipes
          </h1>
          <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            Our cherished collection of time-tested recipes, each one holding a special place in our hearts and our ovens
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {recipes.map((recipe, index) => (
            <div class="bg-white rounded-2xl shadow-lg p-8 transform hover:scale-105 transition-all duration-300 hover:shadow-xl relative overflow-hidden">
              <!-- Decorative elements -->
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-purple-100 to-transparent rounded-full transform translate-x-10 -translate-y-10"></div>
              <div class="absolute bottom-0 left-0 w-16 h-16 bg-gradient-to-tr from-gold-100 to-transparent rounded-full transform -translate-x-8 translate-y-8"></div>
              
              <div class="relative z-10">
                <div class="flex items-start justify-between mb-4">
                  <div class="bg-gradient-to-br from-purple-100 to-gold-100 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="font-bold text-purple-700">{index + 1}</span>
                  </div>
                  <span class="text-2xl ml-4">
                    {index % 4 === 0 ? 'üç™' : index % 4 === 1 ? 'üçû' : index % 4 === 2 ? 'üßÅ' : 'ü•ß'}
                  </span>
                </div>
                
                <h3 class="font-script text-2xl font-bold text-purple-800 mb-4">
                  {recipe.title}
                </h3>
                
                <p class="text-gray-600 leading-relaxed mb-6">
                  {recipe.description}
                </p>
                
                <div class="flex justify-between items-center">
                  <div class="flex flex-col text-sm text-purple-600">
                    {recipe.category && (
                      <span class="font-medium capitalize">{recipe.category}</span>
                    )}
                    {recipe.difficulty_level && (
                      <span class="text-xs text-gray-500 capitalize">
                        {recipe.difficulty_level} level
                      </span>
                    )}
                  </div>
                  <button 
                    class="recipe-learn-more bg-gradient-to-r from-gold-500 to-gold-600 hover:from-gold-600 hover:to-gold-700 text-white px-4 py-2 rounded-full text-sm font-medium transition-all transform hover:scale-105"
                    data-recipe-id={recipe.id}
                  >
                    Learn More
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
        
        <div class="text-center mt-16">
          <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
            <h3 class="font-script text-3xl font-bold text-purple-800 mb-4">
              Want the Full Recipes?
            </h3>
            <p class="text-gray-600 mb-6">
              We're working on sharing our complete recipe collection with you! 
              Sign up for our newsletter to be the first to know when our recipe book becomes available.
            </p>
            <a 
              href="/contact" 
              class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white px-8 py-4 rounded-full font-semibold transition-all transform hover:scale-105 inline-block"
            >
              Stay Updated
            </a>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Recipe Modal Container -->
    <div id="recipe-modal"></div>
  </main>
  

<script>
  import RecipeModal from '../components/RecipeModal.tsx';
  import { bakeryAPI } from '../lib/supabase';
  import { createRoot } from 'react-dom/client';
  import React from 'react';

  let modalRoot: any = null;
  let currentModal: any = null;

  function initializeModal() {
    const container = document.getElementById('recipe-modal');
    if (container && !modalRoot) {
      modalRoot = createRoot(container);
    }
  }

  function showRecipeModal(recipe: any) {
    if (!modalRoot) initializeModal();
    
    if (modalRoot) {
      currentModal = React.createElement(RecipeModal, {
        recipe: recipe,
        isOpen: true,
        onClose: hideRecipeModal
      });
      modalRoot.render(currentModal);
    }
  }

  function hideRecipeModal() {
    if (modalRoot) {
      const emptyModal = React.createElement(RecipeModal, {
        recipe: null,
        isOpen: false,
        onClose: hideRecipeModal
      });
      modalRoot.render(emptyModal);
    }
  }

  // Fetch recipe data when needed
  async function getRecipeById(recipeId: string) {
    try {
      const recipes = await bakeryAPI.getRecipes();
      return recipes.find(recipe => recipe.id === recipeId);
    } catch (error) {
      console.error('Error fetching recipe:', error);
      return null;
    }
  }

  // Add click handlers to "Learn More" buttons
  document.addEventListener('DOMContentLoaded', () => {
    const learnMoreButtons = document.querySelectorAll('.recipe-learn-more');
    
    learnMoreButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        const recipeId = (e.target as HTMLElement).getAttribute('data-recipe-id');
        
        if (recipeId) {
          const recipe = await getRecipeById(recipeId);
          if (recipe) {
            showRecipeModal(recipe);
          }
        }
      });
    });
  });
</script>